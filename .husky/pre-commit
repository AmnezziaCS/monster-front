#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "Regenerating API types from Swagger..."

SPEC_URL="http://localhost:3000/api-json"
OUT_FILE="src/types/api-types.ts"
TMP_FILE="${OUT_FILE}.tmp"

# Check backend availability first
if curl --output /dev/null --silent --head --fail "$SPEC_URL"; then
  echo "Swagger available — regenerating API types..."

  # Delete any leftover temp file
  npx rimraf "$TMP_FILE"

  # Generate into a temporary file
  if npx openapi-typescript "$SPEC_URL" --output "$TMP_FILE"; then
    echo "Generated temporary types: $TMP_FILE"

    # Move into place (atomic replacement)
    mv -f "$TMP_FILE" "$OUT_FILE"

    # Stage the new file for commit
    git add "$OUT_FILE"
    echo "Updated $OUT_FILE and staged for commit."
  else
    echo "openapi-typescript failed — aborting commit."
    npx rimraf "$TMP_FILE"
    exit 1
  fi
else
  echo "Backend not running at $SPEC_URL — skipping API type generation."
fi
